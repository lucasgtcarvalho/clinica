// Schema do banco de dados para sistema SaaS de clínicas de estética
// Multi-tenant com isolamento completo de dados

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT - CLÍNICAS
// ============================================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  logo        String?
  address     String?
  phone       String?
  email       String?
  
  // Personalização
  primaryColor   String   @default("#4F46E5")
  secondaryColor String   @default("#10B981")
  
  // Configurações
  businessHours  Json?    // { monday: { start: "09:00", end: "18:00" }, ... }
  timezone       String   @default("America/Sao_Paulo")
  
  // Status
  isActive    Boolean  @default(true)
  plan        String   @default("basic") // basic, pro, enterprise
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relações
  users           User[]
  clients         Client[]
  services        Service[]
  packages        Package[]
  appointments    Appointment[]
  financials      Financial[]
  notifications   Notification[]
  auditLogs       AuditLog[]
  
  @@map("tenants")
}

// ============================================
// USUÁRIOS DO SISTEMA
// ============================================

model User {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  email       String
  password    String
  phone       String?
  avatar      String?
  
  // Permissões
  role        String   @default("professional") // admin, professional, receptionist
  permissions Json?    // { agenda: true, financeiro: true, ... }
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  lastLoginAt DateTime?
  
  // Relações
  tenant              Tenant         @relation(fields: [tenantId], references: [id])
  appointments        Appointment[]
  financials          Financial[]
  auditLogs           AuditLog[]
  
  @@unique([tenantId, email])
  @@map("users")
}

// ============================================
// CLIENTES DAS CLÍNICAS
// ============================================

model Client {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  cpf         String?
  phone       String
  email       String?
  birthDate   DateTime?
  
  // Endereço
  address     String?
  city        String?
  state       String?
  zipCode     String?
  
  // Informações adicionais
  notes       String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relações
  tenant              Tenant          @relation(fields: [tenantId], references: [id])
  appointments        Appointment[]
  anamnesis           Anamnesis[]
  clientPackages      ClientPackage[]
  financials          Financial[]
  photos              Photo[]
  
  @@unique([tenantId, cpf])
  @@map("clients")
}

// ============================================
// SERVIÇOS
// ============================================

model Service {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  description String?
  duration    Int      // duração em minutos
  price       Decimal  @db.Decimal(10, 2)
  
  // Categorização
  category    String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relações
  tenant                Tenant               @relation(fields: [tenantId], references: [id])
  appointmentServices   AppointmentService[]
  packageServices       PackageService[]
  
  @@map("services")
}

// ============================================
// PACOTES DE SERVIÇOS
// ============================================

model Package {
  id          String   @id @default(uuid())
  tenantId    String
  
  name        String
  description String?
  sessions    Int      // quantidade de sessões
  price       Decimal  @db.Decimal(10, 2)
  discount    Decimal? @db.Decimal(10, 2)
  
  // Validade
  validityDays Int?    // dias de validade após compra
  
  // Status
  isActive    Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relações
  tenant            Tenant           @relation(fields: [tenantId], references: [id])
  packageServices   PackageService[]
  clientPackages    ClientPackage[]
  
  @@map("packages")
}

model PackageService {
  id         String  @id @default(uuid())
  packageId  String
  serviceId  String
  quantity   Int     @default(1)
  
  package    Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service    Service @relation(fields: [serviceId], references: [id])
  
  @@map("package_services")
}

// ============================================
// PACOTES DOS CLIENTES
// ============================================

model ClientPackage {
  id          String   @id @default(uuid())
  clientId    String
  packageId   String
  
  totalSessions    Int
  usedSessions     Int      @default(0)
  remainingSessions Int
  
  purchaseDate     DateTime @default(now())
  expiryDate       DateTime?
  
  // Status
  status      String   @default("active") // active, expired, completed
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relações
  client      Client   @relation(fields: [clientId], references: [id])
  package     Package  @relation(fields: [packageId], references: [id])
  
  @@map("client_packages")
}

// ============================================
// AGENDAMENTOS
// ============================================

model Appointment {
  id          String   @id @default(uuid())
  tenantId    String
  clientId    String
  userId      String?  // profissional responsável
  
  startTime   DateTime
  endTime     DateTime
  
  // Status
  status      String   @default("scheduled") // scheduled, confirmed, in_progress, completed, cancelled
  
  // Observações
  notes       String?
  cancelReason String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relações
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  client              Client               @relation(fields: [clientId], references: [id])
  user                User?                @relation(fields: [userId], references: [id])
  appointmentServices AppointmentService[]
  anamnesis           Anamnesis[]
  photos              Photo[]
  financials          Financial[]
  
  @@map("appointments")
}

// ============================================
// SERVIÇOS DO AGENDAMENTO
// ============================================

model AppointmentService {
  id            String  @id @default(uuid())
  appointmentId String
  serviceId     String
  
  duration      Int
  price         Decimal @db.Decimal(10, 2)
  
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id])
  
  @@map("appointment_services")
}

// ============================================
// FINANCEIRO
// ============================================

model Financial {
  id            String   @id @default(uuid())
  tenantId      String
  clientId      String
  appointmentId String?
  userId        String?  // usuário que registrou
  
  type          String   // income, expense
  category      String   // service, product, other
  description   String
  
  amount        Decimal  @db.Decimal(10, 2)
  
  // Pagamento
  paymentMethod String?  // cash, credit_card, debit_card, pix, transfer
  paymentStatus String   @default("pending") // pending, paid, cancelled, refunded
  
  dueDate       DateTime
  paidAt        DateTime?
  
  // Parcelamento
  installments  Int      @default(1)
  installmentNumber Int  @default(1)
  
  // Observações
  notes         String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
  // Relações
  tenant        Tenant      @relation(fields: [tenantId], references: [id])
  client        Client      @relation(fields: [clientId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  user          User?       @relation(fields: [userId], references: [id])
  
  @@map("financials")
}

// ============================================
// ANAMNESE
// ============================================

model Anamnesis {
  id            String   @id @default(uuid())
  clientId      String
  appointmentId String?
  
  // Dados da anamnese
  data          Json     // Perguntas e respostas personalizáveis
  
  // Assinatura digital
  signature     String?  // Base64 da assinatura
  signedAt      DateTime?
  signedBy      String?  // Nome de quem assinou
  ipAddress     String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relações
  client        Client      @relation(fields: [clientId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  
  @@map("anamnesis")
}

// ============================================
// FOTOS ANTES/DEPOIS
// ============================================

model Photo {
  id            String   @id @default(uuid())
  clientId      String
  appointmentId String?
  
  filename      String
  path          String
  type          String   // before, after
  description   String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relações
  client        Client      @relation(fields: [clientId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  
  @@map("photos")
}

// ============================================
// NOTIFICAÇÕES
// ============================================

model Notification {
  id          String   @id @default(uuid())
  tenantId    String
  
  type        String   // whatsapp, email, push, sms
  recipient   String   // telefone ou email
  subject     String?
  message     String
  
  // Status
  status      String   @default("pending") // pending, sent, failed
  sentAt      DateTime?
  error       String?
  
  // Dados adicionais
  metadata    Json?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relações
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("notifications")
}

// ============================================
// LOGS DE AUDITORIA
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String?
  
  action      String   // create, update, delete, login, logout
  entity      String   // appointment, client, financial, etc
  entityId    String?
  
  // Dados
  oldData     Json?
  newData     Json?
  
  // Informações da requisição
  ipAddress   String?
  userAgent   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relações
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
}
